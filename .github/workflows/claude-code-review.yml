name: Claude Code Review

on:
  pull_request:
    types: [labeled, unlabeled]

jobs:
  qa-label-guard-and-run:
    # Only run the job when this is a labeled event and the PR's labels include the QA label
    if: ${{ github.event.action == 'labeled' && contains(join(github.event.pull_request.labels.*.name, ','), env.LABEL_TO_WATCH) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    env:
      ORG: NativeCLI
      LABEL_TO_WATCH: QA
      COMPLETE_LABEL: "QA Complete"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare environment
        run: |
          echo "REPO=${{ github.repository }}" >> $GITHUB_ENV
          echo "OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV
          echo "ISSUE_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "SENDER=${{ github.event.sender.login }}" >> $GITHUB_ENV
          echo "LABEL_NAME=${{ github.event.label.name }}" >> $GITHUB_ENV

      - name: Check actor is a member of the org
        id: check_member
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const org = process.env.ORG;
            const user = process.env.SENDER;

            const wait = (ms) => new Promise(r => setTimeout(r, ms));
            async function retry(fn, attempts = 3, delayMs = 1000) {
              let lastError;
              for (let i = 0; i < attempts; i++) {
                try {
                  return await fn();
                } catch (err) {
                  lastError = err;
                  if (i < attempts - 1) await wait(delayMs);
                }
              }
              throw lastError;
            }

            try {
              const res = await retry(() => github.rest.orgs.checkMembershipForUser({ org, username: user }));
              return res.status;
            } catch (err) {
              if (err && err.status) return err.status;
              throw err;
            }

      - name: Announce QA started
        if: ${{ steps.check_member.outputs.result == '204' }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.REPO.split('/');
            const issue_number = parseInt(process.env.ISSUE_NUMBER, 10);
            const sender = process.env.SENDER;
            const body = `QA started by @${sender}. Running QA now...`;

            const wait = (ms) => new Promise(r => setTimeout(r, ms));
            async function retry(fn, attempts = 3, delayMs = 1000) {
              let lastError;
              for (let i = 0; i < attempts; i++) {
                try { return await fn(); } catch (err) { lastError = err; if (i < attempts-1) await wait(delayMs); }
              }
              throw lastError;
            }

            await retry(() => github.rest.issues.createComment({ owner, repo, issue_number, body }));
            return true;

      - name: Remove QA label and comment if non-member
        if: ${{ steps.check_member.outputs.result != '204' }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.REPO.split('/');
            const issue_number = parseInt(process.env.ISSUE_NUMBER, 10);

            const wait = (ms) => new Promise(r => setTimeout(r, ms));
            async function retry(fn, attempts = 3, delayMs = 1000) {
              let lastError;
              for (let i = 0; i < attempts; i++) {
                try { return await fn(); } catch (err) { lastError = err; if (i < attempts-1) await wait(delayMs); }
              }
              throw lastError;
            }

            // Attempt to remove the label if present (ignore 404)
            try {
              await retry(() => github.rest.issues.removeLabel({ owner, repo, issue_number, name: process.env.LABEL_TO_WATCH }));
            } catch (e) {
              // ignore
            }

            const body = `Only members of the '${process.env.ORG}' organization may add the '${process.env.LABEL_TO_WATCH}' label. The label has been removed.`;
            await retry(() => github.rest.issues.createComment({ owner, repo, issue_number, body }));
            return true;

      - name: Run Claude Code Review (QA)
        if: ${{ steps.check_member.outputs.result == '204' }}
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please perform QA on this pull request and report any issues, test coverage gaps,
            and any other items that require attention.

            When QA is complete, mark the PR appropriately.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: "On successful QA: remove QA label and add QA Complete"
        if: ${{ steps.check_member.outputs.result == '204' && success() }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.REPO.split('/');
            const issue_number = parseInt(process.env.ISSUE_NUMBER, 10);

            const wait = (ms) => new Promise(r => setTimeout(r, ms));
            async function retry(fn, attempts = 3, delayMs = 1000) {
              let lastError;
              for (let i = 0; i < attempts; i++) {
                try { return await fn(); } catch (err) { lastError = err; if (i < attempts-1) await wait(delayMs); }
              }
              throw lastError;
            }

            // Remove the QA label (ignore errors)
            try {
              await retry(() => github.rest.issues.removeLabel({ owner, repo, issue_number, name: process.env.LABEL_TO_WATCH }));
            } catch (e) {
              // ignore
            }

            // Add the QA Complete label
            await retry(() => github.rest.issues.addLabels({ owner, repo, issue_number, labels: [process.env.COMPLETE_LABEL] }));
            return true;
